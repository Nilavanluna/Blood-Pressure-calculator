name: CD Pipeline - Deployment and Release

on:
  workflow_run:
    workflows: ['CI Pipeline - Build and Test']
    types:
      - completed
    branches:
      - main

env:
  # Base name for the Docker image (pulled from a registry after CI)
  IMAGE_NAME: bp-calculator
  # The environment URL used for E2E and Performance testing of the new version
  TEST_URL: ${{ secrets.STAGING_GREEN_URL }}

jobs:
  # --------------------------------------------------------------------------------
  # JOB 1: QA Deployment (Release Management Strategy: QA)
  # --------------------------------------------------------------------------------
  qa_deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to QA Environment
        # This script should pull the latest image from the registry and deploy it to the QA environment.
        run: scripts/deploy-qa.sh

      - name: Run Smoke Tests on QA
        # Verify the basic functionality before proceeding.
        run: scripts/run-smoke-tests.sh

  # --------------------------------------------------------------------------------
  # JOB 2: Staging Deployment and Pre-Production Testing
  # This serves as the Authorization Gate and is based on a Blue/Green Strategy.
  # --------------------------------------------------------------------------------
  staging_deployment:
    needs: qa_deployment # Only run if QA tests passed
    runs-on: ubuntu-latest
    # Define an environment for security and to enable required reviewers/wait-for
    environment:
      name: Staging
      wait-on: true # Use this if you configure an environment for manual review

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy New Version to Staging-Green (Blue/Green Deployment)
        run: scripts/deploy-green.sh

      - name: Run E2E Tests on Green Environment
        run: scripts/run-e2e-tests.sh

      - name: Setup k6 for Performance Testing
        uses: k6io/action@v2

      - name: Run Performance Tests on Green Environment (k6)
        run: scripts/run-performance-tests.sh

      - name: Run Vulnerability Scan (Security Features)
        # Scan the built container image for known vulnerabilities (Simulated Pen Testing).
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH' # Fail the pipeline on critical or high severity issues.

      # --- Authorization Gate: Manual Approval ---
      - name: Manual Approval Gate for Production Cutover
        # This uses a custom action for an in-workflow approval before the next job starts.
        # NOTE: For an officially supported GitHub environment gate, configure a Required Reviewer on the 'Production' environment.
        uses: trstringer/manual-approval@v1
        if: success() # Only create the approval check if all previous steps succeeded
        with:
          secret: ${{ github.TOKEN }}
          approvers: 'your_github_username' # **CRITICAL: CHANGE THIS** to your GitHub username(s)
          minimum-approvals: 1
          issue-title: 'Production Deployment Approval: ${{ github.sha }}'
          issue-body: 'Approve deployment to production by switching Blue/Green traffic.'

  # --------------------------------------------------------------------------------
  # JOB 3: Production Cutover (Final Deployment Step)
  # Waits for the 'staging_deployment' job to complete AND be manually approved.
  # --------------------------------------------------------------------------------
  production_cutover:
    needs: staging_deployment
    runs-on: ubuntu-latest
    environment: Production # Link to a GitHub Environment for better control/security

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Switch Traffic (Blue/Green Cutover)
        # This single step redirects production traffic to the new Green environment.
        run: scripts/switch-blue-green.sh

      - name: Post-Switch Health Check and Telemetry Verification
        # Verify the new live system is healthy after the switch.
        run: |
          echo "Running health check on the live environment..."
          scripts/health-check.sh
          echo "Verifying continuous telemetry monitoring data flow..."

      - name: Run Post-Deployment Smoke Tests on Production
        run: scripts/run-post-deploy-tests.sh
