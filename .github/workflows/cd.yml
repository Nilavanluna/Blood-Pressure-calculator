name: CD Pipeline

# Trigger CD after successful CI workflow
on:
  workflow_run:
    workflows: ['CI Pipeline'] # Must exactly match the `name:` of your CI workflow
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }} # only run if CI succeeded
    environment: production

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Deploy to QA
      - name: Deploy to QA
        run: pwsh ./scripts/deploy-qa.ps1

      # 3️⃣ Run Smoke Tests in QA
      - name: Run Smoke Tests
        run: pwsh ./scripts/run-smoke-tests.ps1

      # 4️⃣ Deploy to Staging
      - name: Deploy to Staging
        run: pwsh ./scripts/deploy-staging.ps1

      # 5️⃣ Run E2E Tests in Staging
      - name: Run E2E Tests
        run: pwsh ./scripts/run-e2e-tests.ps1

      # 6️⃣ Manual approval before production
      - name: Await Production Approval
        uses: hmarr/auto-approve-action@v2
        if: github.event_name == 'workflow_run' # placeholder; can use environments for real approval
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # 7️⃣ Deploy to Production (Blue-Green)
      - name: Deploy to Production (Blue-Green)
        run: pwsh ./scripts/deploy-production.ps1

      # 8️⃣ Run Post-Deploy Tests
      - name: Run Post-Deploy Tests
        run: pwsh ./scripts/run-postdeploy-tests.ps1

      # 9️⃣ Monitoring Setup
      - name: Monitoring Setup
        run: pwsh ./scripts/monitoring-setup.ps1
