name: CD Pipeline - Deployment and Release

on:
  workflow_run:
    # IMPORTANT: Ensure "CI Pipeline - Build and Test" is the exact name of your CI workflow
    workflows: ['CI Pipeline']
    types:
      - completed
    branches:
      - main

env:
  IMAGE_NAME: bp-calculator
  # Get the Staging URL from repository secrets
  TEST_URL: ${{ secrets.STAGING_GREEN_URL }}

jobs:
  # --------------------------------------------------------------------------------
  # JOB 1: QA Deployment
  # --------------------------------------------------------------------------------
  qa_deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # FIX: Set Execute Permissions for all scripts
      - name: Set Script Permissions
        run: chmod +x scripts/*.sh

      - name: Deploy to QA Environment
        run: scripts/deploy-qa.sh

      - name: Run Smoke Tests on QA
        run: scripts/run-smoke-tests.sh

  # --------------------------------------------------------------------------------
  # JOB 2: Staging Deployment and Pre-Production Testing
  # --------------------------------------------------------------------------------
  staging_deployment:
    needs: qa_deployment
    runs-on: ubuntu-latest
    environment:
      name: Staging

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # FIX: Set Execute Permissions for all scripts
      - name: Set Script Permissions
        run: chmod +x scripts/*.sh

      # NEW STEP: Convert the repository owner name to lowercase and set it as an env var.
      # This resolves the 'Unrecognized function: toLower' error.
      - name: Set Lowercase Repository Owner
        run: echo "GHCR_OWNER=${{ toLower(github.repository_owner) }}" >> $GITHUB_ENV

      - name: Deploy New Version to Staging-Green (Blue/Green Deployment)
        run: scripts/deploy-green.sh

      - name: Run E2E Tests on Green Environment
        run: scripts/run-e2e-tests.sh

      # Login to Container Registry to pull image for scanning
      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Vulnerability Scan (Security Features)
        uses: aquasecurity/trivy-action@master
        with:
          # FIX: Reference the newly created lowercase environment variable (GHCR_OWNER)
          image-ref: ghcr.io/${{ env.GHCR_OWNER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      # Using grafana/run-k6-action@v1 based on your initial logs
      - name: Run Performance Tests on Green Environment (k6)
        uses: grafana/run-k6-action@v1
        with:
          script: scripts/performance-test.js
          environment-variables: K6_BASE_URL=${{ env.TEST_URL }}

      # --- Authorization Gate: Manual Approval ---
      - name: Manual Approval Gate for Production Cutover
        uses: trstringer/manual-approval@v1
        if: success()
        with:
          secret: ${{ github.TOKEN }}
          approvers: 'your_github_username' # **CRITICAL: CHANGE THIS**
          minimum-approvals: 1
          issue-title: 'Production Deployment Approval: ${{ github.sha }}'
          issue-body: 'Approve deployment to production by switching Blue/Green traffic.'

  # --------------------------------------------------------------------------------
  # JOB 3: Production Cutover
  # --------------------------------------------------------------------------------
  production_cutover:
    needs: staging_deployment
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Script Permissions
        run: chmod +x scripts/*.sh

      - name: Switch Traffic (Blue/Green Cutover)
        run: scripts/switch-blue-green.sh

      - name: Post-Switch Health Check and Telemetry Verification
        run: |
          scripts/health-check.sh
          echo "Verifying continuous telemetry monitoring data flow..."

      - name: Run Post-Deployment Smoke Tests on Production
        run: scripts/run-post-deploy-tests.sh
