name: CD Pipeline

# Trigger CD automatically after CI workflow succeeds
on:
  workflow_run:
    workflows: ['CI Pipeline'] # must match the `name:` of your CI workflow
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    environment: production # enables manual approval in GitHub UI

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Deploy to QA
      - name: Deploy to QA
        run: pwsh -File ./scripts/deploy-qa.ps1

      # 3️⃣ Run Smoke Tests in QA
      - name: Run Smoke Tests
        run: pwsh -File ./scripts/run-smoke-tests.ps1

      # 4️⃣ Deploy to Staging
      - name: Deploy to Staging
        run: pwsh -File ./scripts/deploy-staging.ps1

      # 5️⃣ Run E2E Tests in Staging
      - name: Run E2E Tests
        run: pwsh -File ./scripts/run-e2e-tests.ps1

      # 6️⃣ Manual approval before production
      - name: Await Production Approval
        run: echo "Waiting for production approval..." # Replace later with GitHub Environment approvals

      # 7️⃣ Deploy to Production (Blue-Green)
      - name: Deploy to Production (Blue-Green)
        run: pwsh -File ./scripts/deploy-production.ps1

      # 8️⃣ Run Post-Deploy Tests
      - name: Run Post-Deploy Tests
        run: pwsh -File ./scripts/run-postdeploy-tests.ps1

      # 9️⃣ Monitoring Setup
      - name: Monitoring Setup
        run: pwsh -File ./scripts/monitoring-setup.ps1
