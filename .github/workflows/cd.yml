name: CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set secrets
        run: |
          echo "BLUE=$RENDER_BLUE_SERVICE_ID"
          echo "GREEN=$RENDER_GREEN_SERVICE_ID"
          echo "DOMAIN=$CUSTOM_DOMAIN"

      - name: Make scripts executable
        run: chmod +x ./scripts/*.sh

      - name: Deploy to QA
        run: bash ./scripts/deploy-qa.sh

      - name: Run Smoke Tests
        run: bash ./scripts/run-smoke-tests.sh

      - name: Deploy to Staging
        run: bash ./scripts/deploy-staging.sh

      - name: Run E2E Tests
        run: bash ./scripts/run-e2e-tests.sh

      - name: Manual Approval
        run: echo "Awaiting manual production approval..."

      - name: Deploy to Green (Production)
        run: bash ./scripts/deploy-green.sh

      - name: Blue-Green Switch
        run: bash ./scripts/switch-blue-green.sh

      - name: Post-Deploy Tests
        run: bash ./scripts/run-post-deploy-tests.sh

      - name: Health Check
        run: bash ./scripts/health-check.sh
