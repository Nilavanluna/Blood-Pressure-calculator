name: CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  # 1. QA and Staging Deploy (Unchanged)
  qa_staging_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Make scripts executable
        run: chmod +x ./scripts/*.sh

      - name: Deploy to QA
        run: bash ./scripts/deploy-qa.sh

      - name: Run Smoke Tests
        run: bash ./scripts/run-smoke-tests.sh

      - name: Deploy to Staging
        run: bash ./scripts/deploy-staging.sh

      - name: Run E2E Tests
        run: bash ./scripts/run-e2e-tests.sh

  # 2. The Manual Approval Gate
  approval_gate:
    runs-on: ubuntu-latest
    needs: [qa_staging_deploy] # MUST complete the previous job first

    # ðŸŒŸ THIS IS THE CORRECT PLACE FOR THE ENVIRONMENT KEYWORD ðŸŒŸ
    environment:
      name: production # This triggers the manual review set up in step 1

    steps:
      - name: Approval Step Placeholder
        run: echo "Waiting for manual approval to deploy to production..."
        # This step simply runs while the gate holds the job.

  # 3. Production Deployment (Blue/Green)
  production_deploy:
    runs-on: ubuntu-latest
    needs: [approval_gate] # MUST wait for the approval job to complete

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Make scripts executable
        run: chmod +x ./scripts/*.sh

      - name: Deploy to Green (Production)
        run: bash ./scripts/deploy-green.sh

      - name: Blue-Green Switch
        run: bash ./scripts/switch-blue-green.sh

      - name: Post-Deploy Tests
        run: bash ./scripts/run-post-deploy-tests.sh

      - name: Health Check
        run: bash ./scripts/health-check.sh
