name: CD Pipeline - Multi-Environment Deployment

on:
  workflow_run:
    workflows: ['CI Pipeline']
    types:
      - completed
    branches:
      - main

jobs:
  # ============================================================
  # STAGE 1: Deploy to QA Environment
  # ============================================================
  deploy-qa:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: QA
      url: https://bp-calculator-qa.onrender.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render QA
        run: |
          echo "Triggering Render QA deployment..."
          curl -X POST ${{ secrets.RENDER_QA_DEPLOY_HOOK }}

      - name: Wait for deployment
        run: sleep 60

      - name: Health check QA
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://bp-calculator-qa.onrender.com)
          if [ $response -eq 200 ]; then
            echo "‚úÖ QA environment is healthy"
          else
            echo "‚ùå QA environment failed health check"
            exit 1
          fi

      - name: Smoke test - Basic functionality
        run: |
          echo "Running basic smoke tests..."
          response=$(curl -s https://bp-calculator-qa.onrender.com)
          if echo "$response" | grep -q "Blood Pressure"; then
            echo "‚úÖ Smoke test passed"
          else
            echo "‚ùå Smoke test failed"
            exit 1
          fi

  # ============================================================
  # STAGE 2: Deploy to Staging Environment
  # ============================================================
  deploy-staging:
    needs: deploy-qa
    runs-on: ubuntu-latest
    environment:
      name: Staging
      url: https://bp-calculator-staging.onrender.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Deploy to Render Staging
        run: |
          echo "Triggering Render Staging deployment..."
          curl -X POST ${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}

      - name: Wait for deployment
        run: sleep 60

      - name: Health check Staging
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://bp-calculator-staging.onrender.com)
          if [ $response -eq 200 ]; then
            echo "‚úÖ Staging environment is healthy"
          else
            echo "‚ùå Staging environment failed health check"
            exit 1
          fi

      - name: Run E2E tests on Staging
        run: |
          echo "Running E2E tests against staging..."
          # Simulate E2E tests for now
          curl -X POST https://bp-calculator-staging.onrender.com \
            -d "Systolic=120&Diastolic=80" \
            -s -o /dev/null -w "%{http_code}" | grep -q "200" && echo "‚úÖ E2E test passed"

      - name: Performance test with k6
        uses: grafana/k6-action@v0.3.1
        with:
          filename: scripts/performance-test.js
        env:
          K6_BASE_URL: https://bp-calculator-staging.onrender.com

      - name: Security scan
        run: |
          echo "Running security scan..."
          dotnet list package --vulnerable --include-transitive
          if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è Security vulnerabilities found"
          fi

  # ============================================================
  # STAGE 3: Deploy to Production (Manual Approval Required)
  # ============================================================
  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment:
      name: Production
      url: https://bp-calculator-prod.onrender.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render Production
        run: |
          echo "Triggering Render Production deployment..."
          curl -X POST ${{ secrets.RENDER_PROD_DEPLOY_HOOK }}

      - name: Wait for deployment
        run: sleep 60

      - name: Health check Production
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://bp-calculator-prod.onrender.com)
          if [ $response -eq 200 ]; then
            echo "‚úÖ Production environment is healthy"
          else
            echo "‚ùå Production environment failed health check"
            exit 1
          fi

      - name: Post-deployment verification
        run: |
          echo "Verifying production deployment..."
          response=$(curl -s https://bp-calculator-prod.onrender.com)
          if echo "$response" | grep -q "Blood Pressure"; then
            echo "‚úÖ Production verification passed"
          else
            echo "‚ùå Production verification failed"
            exit 1
          fi

      - name: Notify deployment success
        run: |
          echo "üéâ Production deployment successful!"
          echo "URL: https://bp-calculator-prod.onrender.com"
