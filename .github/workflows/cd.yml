name: CD Pipeline - Deployment and Release

on:
  workflow_run:
    workflows: ['CI Pipeline - Build and Test']
    types:
      - completed
    branches:
      - main

env:
  IMAGE_NAME: bp-calculator

jobs:
  # --------------------------------------------------------------------------------
  # JOB 1: QA Deployment
  # --------------------------------------------------------------------------------
  qa_deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Script Permissions
        run: chmod +x scripts/*.sh

      - name: Deploy to QA Environment
        run: scripts/deploy-qa.sh

      - name: Run Smoke Tests on QA
        run: scripts/run-smoke-tests.sh

  # --------------------------------------------------------------------------------
  # JOB 2: Staging Deployment + Security Testing
  # --------------------------------------------------------------------------------
  staging_deployment:
    needs: qa_deployment
    runs-on: ubuntu-latest
    environment:
      name: Staging

    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Script Permissions
        run: chmod +x scripts/*.sh

      - name: Set Lowercase Repository Owner
        run: |
          LOWER_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "GHCR_OWNER=$LOWER_OWNER" >> $GITHUB_ENV

      - name: Deploy New Version to Staging-Green (Blue/Green Deployment)
        run: scripts/deploy-green.sh

      - name: Run E2E Tests on Green Environment
        run: scripts/run-e2e-tests.sh

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Vulnerability Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ env.GHCR_OWNER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: table
          severity: CRITICAL
          exit-code: 1
          trivyignores: .trivyignore

      # ------------------------------------------
      # OWASP ZAP DAST Scan — Render Dynamic URL
      # ------------------------------------------
      - name: Run DAST Scan (OWASP ZAP Baseline)
        run: |
          SERVICE_ID="${{ secrets.RENDER_GREEN_SERVICE_ID }}"
          RENDER_API_KEY="${{ secrets.RENDER_API_KEY }}"

          TARGET_URL=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$SERVICE_ID" | jq -r '.serviceDetails.url')

          if [ -z "$TARGET_URL" ] || [ "$TARGET_URL" == "null" ]; then
            echo "Error: Could not fetch TARGET_URL from Render. Check your service ID and API key."
            exit 1
          fi

          # Add https:// if missing
          if ! [[ "$TARGET_URL" =~ ^https?:// ]]; then
            TARGET_URL="https://$TARGET_URL"
          fi

          echo "ZAP scanning target: $TARGET_URL"

          /usr/bin/docker run \
            -v ${{ github.workspace }}:/zap/wrk/:rw \
            -w /zap/wrk \
            --user "$(id -u):$(id -g)" \
            --network host \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t "$TARGET_URL" \
            -J /zap/wrk/report_json.json \
            -w /zap/wrk/report_md.md \
            -r /zap/wrk/report_html.html \
            -a \
            -I \
            -D 2 \
            || echo "ZAP found issues — ignoring WARN/INFO (pipeline will not fail)"

      # Upload ZAP reports as GitHub artifacts (v4)
      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            report_json.json
            report_md.md
            report_html.html

      - name: Manual Approval Gate for Production Cutover
        uses: trstringer/manual-approval@v1
        if: success()
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: 'Nilavanluna'
          minimum-approvals: 1
          issue-title: 'Production Deployment Approval: ${{ github.sha }}'
          issue-body: 'Approve production deployment (Blue/Green switch).'

  # --------------------------------------------------------------------------------
  # JOB 3: Production Cutover
  # --------------------------------------------------------------------------------
  production_cutover:
    needs: staging_deployment
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Script Permissions
        run: chmod +x scripts/*.sh

      - name: Switch Traffic (Blue/Green Cutover)
        run: scripts/switch-blue-green.sh

      - name: Post-Switch Health Check and Telemetry Verification
        run: |
          scripts/health-check.sh
          echo "Telemetry: OK"

      - name: Run Post-Deployment Smoke Tests on Production
        run: scripts/run-post-deploy-tests.sh
